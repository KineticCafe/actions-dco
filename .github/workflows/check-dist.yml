# In GitHub Actions written in TypeScript, `dist/` is a special directory. When you
# reference an action with the `uses:` property, `dist/index.js` is the code that will be
# run, and `dist/index.js` file is transpiled from other source files. This workflow
# ensures the `dist/` directory contains the expected transpiled code.
#
# If this workflow is run from a feature branch, it will act as an additional CI check and
# fail if the checked-in `dist/` directory does not match what is expected from the build.
name: Check Transpiled JavaScript

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions: {}

jobs:
  check-dist:
    name: Check dist/
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Harden the runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          disable-sudo: true
          egress-policy: block
          allowed-endpoints: >
            github.com:443
            registry.npmjs.org:443
            release-assets.githubusercontent.com:443
            nodejs.org:443

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd #v6.0.2
        with:
          persist-credentials: false

      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 #v4.2.0

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 #v6.2.0
        with:
          node-version: 24.x
          cache: pnpm

      - run: pnpm install --frozen-lockfile

      - run: |
          pnpm run build && pnpm run package

      # This will fail the workflow if the PR wasn't created by Dependabot.
      - name: Compare Directories
        run: |
          if [[ "$(git diff --ignore-space-at-eol --text dist/ | wc -l)" -gt 0 ]]; then
            echo "Detected uncommitted changes after build. See status below:"
            git diff --text --ignore-space-at-eol dist/
            exit 1
          fi
        id: diff

      # If `dist/` was different than expected, and this was not a Dependabot
      # PR, upload the expected version as a workflow artifact.
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: ${{ failure() && steps.diff.outcome == 'failure' }}
        with:
          name: dist
          path: dist/

  rebuild-dist:
    name: Rebuild dist/ for Dependabot PRs
    if: github.event.pull_request.user.login == 'dependabot[bot]' && github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    permissions:
      contents: write # Rewrite `dist/` and `biome.json` if required, but only for dependabot PRs.

    steps:
      - name: Harden the runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          disable-sudo: true
          egress-policy: block
          allowed-endpoints: >
            github.com:443
            registry.npmjs.org:443
            release-assets.githubusercontent.com:443
            nodejs.org:443

      - id: app-token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        with:
          app-id: ${{ secrets.KINETICCAFE_BOT_CLIENT_ID }}
          private-key: ${{ secrets.KINETICCAFE_BOT_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - id: app-user-id
        run: |
          echo "user-id=$(gh api "/users/${APP_SLUG}[bot]" --jq .id)" >>"$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          APP_SLUG: ${{ steps.app-token.outputs.app-slug }}

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd #v6.0.2
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0
          persist-credentials: false
          token: ${{ steps.app-token.outputs.token }}

      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 #v4.2.0

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 #v6.2.0
        with:
          node-version: 24.x
          cache: pnpm

      - run: pnpm install --frozen-lockfile

      - name: Migrate Biome configuration
        run: pnpm exec biome migrate --write

      - name: Rebuild dist/
        run: pnpm run all

      - name: Commit and push changed dist/ and biome.json files
        run: |
          git config user.name "${APP_SLUG}[bot]"
          git config user.email "[bot]@users.noreply.github.com"
          git config user.email "${APP_ID}+${APP_SLUG}[bot]@users.noreply.github.com"

          git add dist/ biome.json

          if ! git diff --quiet; then
            echo "::error::There are additional changes that need review."
            exit 1
          elif ! git diff --staged --quiet; then
            git commit -m "deps: Update dist/ after dependabot update"
            git push
          else
            exit 0
          fi
        env:
          APP_SLUG: ${{ steps.app-token.outputs.app-slug }}
          APP_ID: ${{ steps.app-user-id.outputs.user-id }}
